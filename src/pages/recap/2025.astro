---
import '@/styles/globals.css';
import { getAllBlogPosts } from '@/lib/markdown';
import { absoluteUrl } from '@/lib/utils';
import { format } from 'date-fns';
import { History, Code2, Cpu, Globe, Terminal, Sparkles } from 'lucide-react';
import ScrollReveal from '@/components/recap/scroll-reveal.astro';
import StatCard from '@/components/recap/stat-card.astro';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import RecapLayout from '@/layouts/recap-layout.astro';

// --- Data Fetching & Analysis ---
const allPosts = await getAllBlogPosts();
const posts2025 = allPosts.filter((post) => {
  const date = new Date(post.data.date);
  return date.getFullYear() === 2025;
});

const totalPosts = posts2025.length;
const totalWords = posts2025.reduce(
  (acc, post) => acc + (post.body?.length || 0),
  0,
);

// Analyze Tags
const tagCounts: Record<string, number> = {};
posts2025.forEach((post) => {
  post.data.tags?.forEach((tag) => {
    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
  });
});

// Category Aggregation (Based on analysis)
const aiCount =
  (tagCounts['ClaudeCode'] || 0) +
  (tagCounts['MCP'] || 0) +
  (tagCounts['AI'] || 0);
const edgeCount =
  (tagCounts['CloudflareWorkers'] || 0) +
  (tagCounts['HonoX'] || 0) +
  (tagCounts['Hono'] || 0) +
  (tagCounts['Cloudflare'] || 0);
const frontendCount =
  (tagCounts['Next.js'] || 0) +
  (tagCounts['React'] || 0) +
  (tagCounts['TypeScript'] || 0);

const canonicalUrl = absoluteUrl('/recap/2025');
const title = '2025 REWIND | sui Tech Blog';
const description = 'A look back at the code and stories of 2025.';

// Sort posts by date for the timeline at the end
const sortedPosts = [...posts2025].sort(
  (a, b) => new Date(a.data.date).getTime() - new Date(b.data.date).getTime(),
);
---

<RecapLayout
  title={title}
  description={description}
  url={canonicalUrl}
  ogImage={absoluteUrl('/recap/ogp/2025.png')}
>
  <style slot='head'>
    .text-gradient {
      background: linear-gradient(to right, #1a1a1a, #666);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .text-glow {
      /* Stronger shadow for light mode? Or maybe just remove it/make it subtle */
      text-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
    }
  </style>

  <!-- Hero Section -->
  <header
    class='h-screen flex flex-col justify-center items-center relative overflow-hidden px-4'
  >
    <div
      class='absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-blue-100/50 via-transparent to-transparent opacity-70 animate-pulse'
    >
    </div>

    <ScrollReveal animation='fade-in' delay={200}>
      <h1
        class='text-[15vw] font-black tracking-tighter leading-none text-gradient text-glow select-none'
      >
        2025
      </h1>
    </ScrollReveal>

    <ScrollReveal animation='fade-in' delay={500}>
      <p
        class='text-xl md:text-2xl font-light text-gray-500 tracking-[0.5em] uppercase mt-4'
      >
        Year in Code
      </p>
    </ScrollReveal>

    <div class='absolute bottom-10 animate-bounce text-gray-400'>
      <svg
        xmlns='http://www.w3.org/2000/svg'
        width='24'
        height='24'
        viewBox='0 0 24 24'
        fill='none'
        stroke='currentColor'
        stroke-width='2'
        stroke-linecap='round'
        stroke-linejoin='round'><path d='M7 13l5 5 5-5M7 6l5 5 5-5'></path></svg
      >
    </div>
  </header>

  <main class='max-w-4xl mx-auto px-6 py-20 space-y-40'>
    <!-- Section 1: Intro & Total Output -->
    <section class='grid md:grid-cols-2 gap-12 items-center'>
      <ScrollReveal animation='slide-in-left'>
        <div class='space-y-6'>
          <h2
            class='text-3xl md:text-4xl font-bold leading-tight text-gray-900'
          >
            振り返れば、<br />
            <span class='text-blue-600'>常にコードを書いていた</span>1年でした。
          </h2>
          <p class='text-lg text-gray-600 leading-relaxed font-medium'>
            2025年は、ただひたすらにアウトプットを続けた年でした。
            QiitaとZennの記事を全部移植して、本格的にブログ運用を始めました。
            技術的な探求、日々の学び、そして時には失敗も。
            すべてをブログという形に残してきました。
          </p>
        </div>
      </ScrollReveal>

      <div class='space-y-6'>
        <ScrollReveal animation='slide-in-right' delay={200}>
          <StatCard label='Total Posts' value={totalPosts} suffix='記事'>
            <Terminal slot='icon' className='size-6 text-blue-600' />
          </StatCard>
        </ScrollReveal>

        <ScrollReveal animation='slide-in-right' delay={400}>
          <StatCard label='Total Characters' value={totalWords} suffix='文字'>
            <Code2 slot='icon' className='size-6 text-purple-600' />
          </StatCard>
        </ScrollReveal>
      </div>
    </section>

    <!-- Section 2: AI Tech -->
    <section
      class='grid md:grid-cols-2 gap-12 items-center md:flex-row-reverse'
    >
      <!-- Text on Right (Desktop) -->
      <ScrollReveal animation='slide-in-right' class='md:order-2'>
        <div class='space-y-6'>
          <div>
            <h2
              class='text-3xl md:text-4xl font-bold leading-tight text-gray-900'
            >
              <span class='text-purple-600'>生成AI</span>と共に、<br />
              コードを書く。
            </h2>
            <p class='text-lg text-gray-600 leading-relaxed mt-6 font-medium'>
              Claude CodeやMCPなど、AI技術の進化は止まりませんでした。
              開発スタイルそのものが大きく変わった1年。
              AIはもはやツールではなく、パートナーとして定着しました。
            </p>
          </div>
        </div>
      </ScrollReveal>

      <!-- Stat on Left (Desktop) -->
      <ScrollReveal animation='slide-in-left' class='md:order-1'>
        <StatCard label='AI & Agentic Posts' value={aiCount} suffix='記事'>
          <Sparkles slot='icon' className='size-6 text-yellow-500' />
        </StatCard>
      </ScrollReveal>
    </section>

    <!-- Section 3: Edge Architecture -->
    <section class='grid md:grid-cols-2 gap-12 items-center'>
      <ScrollReveal animation='slide-in-left'>
        <div class='space-y-6'>
          <h2
            class='text-3xl md:text-4xl font-bold leading-tight text-gray-900'
          >
            <span class='text-orange-600'>Cloudflare Workers</span><br />
            で遊んだ年。
          </h2>
          <p class='text-lg text-gray-600 leading-relaxed font-medium'>
            Cloudflareの製品は、無料で高機能な点が魅力です。
            Honoなどと組み合わせて、Workersで色々なものを作って試した1年でした。
          </p>
        </div>
      </ScrollReveal>

      <ScrollReveal animation='slide-in-right'>
        <StatCard
          label='Cloudflare Workers Posts'
          value={edgeCount}
          suffix='記事'
        >
          <Globe slot='icon' className='size-6 text-orange-600' />
        </StatCard>
      </ScrollReveal>
    </section>

    <!-- Section 4: Modern Frontend -->
    <section
      class='grid md:grid-cols-2 gap-12 items-center md:flex-row-reverse'
    >
      <ScrollReveal animation='slide-in-right' class='md:order-2'>
        <div>
          <h2
            class='text-3xl md:text-4xl font-bold leading-tight text-gray-900'
          >
            <span class='text-black'>Next.js</span>から<br />
            <span class='text-purple-600'>Astro</span>へ。
          </h2>
          <p class='text-lg text-gray-600 leading-relaxed mt-6 font-medium'>
            長年使っていたNext.jsから、Astroへと技術スタックを移行しました。
            ブログという用途に特化したシンプルさと、パフォーマンスの高さが決め手でした。
            最適な構成を探すための試行錯誤は、これからも終わることはありません。
          </p>
        </div>
      </ScrollReveal>

      <ScrollReveal animation='slide-in-left' class='md:order-1'>
        <StatCard label='Frontend Posts' value={frontendCount} suffix='記事'>
          <Cpu slot='icon' className='size-6 text-purple-600' />
        </StatCard>
      </ScrollReveal>
    </section>

    <!-- Final: Timeline / Grid -->
    <section class='py-20'>
      <ScrollReveal animation='slide-in-bottom'>
        <h2
          class='text-center text-2xl font-light tracking-[0.2em] mb-12 text-gray-400 uppercase'
        >
          All Memories of 2025
        </h2>
      </ScrollReveal>

      <div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'>
        {
          sortedPosts.map((post, i) => {
            const displayUrl =
              post.data.icon_url ||
              (post.data.icon?.startsWith('https://') ? post.data.icon : null);
            // If displayUrl is null, use post.data.icon as raw text (emoji)
            const emojiIcon =
              !displayUrl && post.data.icon ? post.data.icon : null;

            return (
              <ScrollReveal animation='fade-in' delay={i * 50} class='h-full'>
                <a href={`/blog/${post.id}`} class='block h-full group'>
                  <Card className='h-full flex flex-col bg-white border-gray-300 border hover:border-blue-400 hover:shadow-xl transition-all duration-300 group-hover:-translate-y-1'>
                    <CardHeader className='block space-y-4 p-6'>
                      <div class='flex justify-between items-start mb-4'>
                        <div class='text-xs font-mono text-gray-400 self-center'>
                          {format(post.data.date, 'yyyy/MM/dd')}
                        </div>
                        {displayUrl && (
                          <div class='w-8 h-8 shrink-0'>
                            <img
                              src={displayUrl}
                              alt=''
                              class='w-full h-full object-contain'
                            />
                          </div>
                        )}
                        {emojiIcon && (
                          <div class='text-2xl leading-none w-8 h-8 flex items-center justify-center shrink-0'>
                            {emojiIcon}
                          </div>
                        )}
                      </div>
                      <CardTitle className='text-base font-bold leading-relaxed text-gray-800 group-hover:text-blue-600 transition-colors line-clamp-3'>
                        {post.data.title}
                      </CardTitle>
                    </CardHeader>
                    {post.data.tags && (
                      <CardContent className='mt-auto pt-0 px-6 pb-6'>
                        <div class='flex flex-wrap gap-2'>
                          {post.data.tags.slice(0, 3).map((tag) => (
                            <span class='text-[10px] px-2 py-1 bg-gray-100 rounded-full text-gray-500 border border-gray-200 font-medium'>
                              {tag}
                            </span>
                          ))}
                        </div>
                      </CardContent>
                    )}
                  </Card>
                </a>
              </ScrollReveal>
            );
          })
        }
      </div>
    </section>

    <!-- Closing Message -->
    <section
      class='py-32 flex flex-col items-center justify-center text-center px-6'
    >
      <ScrollReveal animation='slide-in-bottom'>
        <div class='flex items-center justify-center gap-3 md:gap-5 mb-8'>
          <h2
            class='text-4xl md:text-6xl font-black tracking-tight text-gray-900 leading-none mt-1'
          >
            Thank You <span class='text-blue-600'>2025</span>
          </h2>
        </div>
        <p
          class='text-gray-600 max-w-xl mx-auto leading-relaxed text-lg font-medium'
        >
          読んでいただいた皆様、フィードバックをくださった皆様、<br
            class='hidden md:block'
          />
          本当にありがとうございました。<br />
          2026年も、よろしくお願いします。
        </p>
      </ScrollReveal>
    </section>

    <!-- Footer Navigation -->
    <footer class='text-center py-20 border-t border-gray-200'>
      <a
        href='/recap'
        class='inline-flex items-center gap-2 text-gray-400 hover:text-gray-800 transition-colors uppercase tracking-widest text-sm'
      >
        <History className='size-4' />
        Back to Archive
      </a>
    </footer>
  </main>
</RecapLayout>
