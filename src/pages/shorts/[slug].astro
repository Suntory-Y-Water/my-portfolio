---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { Icons } from '@/components/icons';

import { compileMarkdown } from '@/components/feature/content/custom-markdown';
import MarkdownContent from '@/components/feature/content/markdown-content.astro';
import { splitMarkdownPages } from '@/lib/shorts';

export async function getStaticPaths() {
  const shorts = await getCollection('shorts');
  const sortedShorts = shorts.sort(
    (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
  );

  return await Promise.all(
    sortedShorts.map(async (short, index) => {
      // Loop: last short -> first short
      const nextShort =
        index < sortedShorts.length - 1
          ? sortedShorts[index + 1]
          : sortedShorts[0];

      // Split markdown into pages
      const pages = splitMarkdownPages(short.body ?? '');
      const compiledPages = await Promise.all(
        pages.map((page) => compileMarkdown({ source: page })),
      );

      return {
        params: { slug: short.id },
        props: { short, nextShort, compiledPages },
      };
    }),
  );
}

const { short, nextShort, compiledPages } = Astro.props;
---

<BaseLayout title={short.data.title} description={short.data.title}>
  <div class='flex items-center justify-center w-full h-full py-4'>
    <div class='relative w-full max-w-[430px] h-[700px] shrink-0'>
      <article
        class='relative flex h-full w-full flex-col items-center justify-center rounded-xl bg-background text-lg text-foreground overflow-hidden shadow-2xl border border-border'
      >
        <div
          class='absolute top-0 left-0 right-0 z-20 bg-background/98 backdrop-blur-md border-b border-border/50'
        >
          <div class='flex items-start gap-3 px-4 py-4'>
            <a
              href='/shorts'
              class='flex items-center justify-center transition-opacity hover:opacity-70 shrink-0 mt-1'
              aria-label='戻る'
            >
              <Icons.ArrowLeft className='h-6 w-6 text-foreground' />
            </a>
            <h2 class='font-bold text-lg'>
              {short.data.title}
            </h2>
          </div>

          <div class='flex justify-center gap-2 px-4 pb-4' id='progress-bar'>
            {
              compiledPages.map((_, index) => (
                <div
                  class='h-1 flex-1 bg-muted/50 rounded-full overflow-hidden transition-all duration-300'
                  data-progress-bar={index}
                >
                  <div
                    class='h-full bg-primary w-0 origin-left transition-all duration-300'
                    data-progress-fill={index}
                  />
                </div>
              ))
            }
          </div>
        </div>

        <div
          class='flex w-full h-full overflow-x-hidden relative snap-x snap-mandatory'
          id='pages-container'
        >
          {
            compiledPages.map((pageHtml, index) => (
              <div
                class='flex flex-col w-full h-full p-6 pt-32 pb-6 overflow-y-auto scrollbar-hide overscroll-contain shrink-0 snap-start'
                data-page={index}
              >
                <div class='prose dark:prose-invert prose-zinc max-w-none text-base leading-relaxed'>
                  <MarkdownContent html={pageHtml} />
                </div>
              </div>
            ))
          }
        </div>

        <a
          href={`/shorts/${nextShort.id}`}
          class='absolute bottom-6 right-1/2 translate-x-1/2 z-30 flex h-12 w-12 items-center justify-center rounded-full bg-primary text-primary-foreground shadow-xl transition-all duration-200 hover:scale-110 active:scale-95 border-2 border-background'
          aria-label='次のShort'
        >
          <Icons.ArrowRight className='h-6 w-6' />
        </a>
      </article>
    </div>
  </div>
</BaseLayout>

<script>
  function initShortsPage() {
    const container = document.getElementById('pages-container');
    if (!container) return;

    let currentPage = 0;
    let touchStartX = 0;
    let touchEndX = 0;

    const totalPages = container.querySelectorAll('[data-page]').length || 0;

    function updateProgressBars() {
      for (let i = 0; i < totalPages; i++) {
        const fill = document.querySelector<HTMLElement>(
          `[data-progress-fill="${i}"]`,
        );
        if (fill) {
          if (i < currentPage) {
            fill.style.width = '100%';
          } else if (i === currentPage) {
            fill.style.width = '100%';
          } else {
            fill.style.width = '0%';
          }
        }
      }
    }

    function goToPage(pageIndex: number) {
      if (pageIndex < 0 || pageIndex >= totalPages) return;

      currentPage = pageIndex;
      container.scrollTo({
        left: pageIndex * container.clientWidth,
        behavior: 'smooth',
      });
      updateProgressBars();
    }

    function handleSwipe() {
      const swipeThreshold = 50;
      const diff = touchStartX - touchEndX;

      if (Math.abs(diff) < swipeThreshold) return;

      if (diff > 0) {
        goToPage(currentPage + 1);
      } else {
        goToPage(currentPage - 1);
      }
    }

    container.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    });

    container.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    });

    container.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (
        target.tagName === 'A' ||
        target.closest('a') ||
        target.tagName === 'BUTTON' ||
        target.closest('button')
      ) {
        return;
      }

      const rect = container.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickPosition = clickX / rect.width;

      if (clickPosition > 0.5) {
        goToPage(currentPage + 1);
      } else {
        goToPage(currentPage - 1);
      }
    });

    updateProgressBars();
  }

  // Run on initial load
  initShortsPage();

  // Run after view transitions (if enabled)
  document.addEventListener('astro:page-load', initShortsPage);
</script>
