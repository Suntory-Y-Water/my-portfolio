---
import BaseLayout from '@/layouts/BaseLayout.astro';
import ShortsGrid from '@/components/feature/shorts/shorts-grid.astro';
import { getCollection } from 'astro:content';
import { Icons } from '@/components/icons';

import { compileMarkdown } from '@/components/feature/content/custom-markdown';
import { getFirstPage } from '@/lib/shorts';

const allShorts = await getCollection('shorts');
const sortedShorts = allShorts.sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);

const compiledShorts = await Promise.all(
  sortedShorts.map(async (short) => {
    // Split BEFORE compiling
    const firstPageMarkdown = getFirstPage(short.body ?? '');
    const compiledHtml = await compileMarkdown({ source: firstPageMarkdown });
    return {
      ...short,
      body: compiledHtml,
    };
  }),
);

const title = 'Shorts';
const description = '技術的な短いメモやTips、Q&Aなどのまとめ';
---

<BaseLayout title={title} description={description}>
  <section class='space-y-10' data-pagefind-ignore>
    <div class='space-y-3 border-b border-border/60 pb-4'>
      <nav class='flex items-center gap-2 text-sm text-muted-foreground'>
        <a href='/' class='transition-colors hover:text-primary'> Home </a>
        <Icons.ChevronRight client:load className='size-4' />
        <span class='text-foreground'>Shorts</span>
      </nav>

      <div class='space-y-2'>
        <h1 class='text-3xl font-bold tracking-tight md:text-4xl'>Shorts</h1>
        <p class='text-base text-muted-foreground'>
          {description}
        </p>
      </div>
    </div>

    <ShortsGrid shorts={compiledShorts} />
  </section>
</BaseLayout>
