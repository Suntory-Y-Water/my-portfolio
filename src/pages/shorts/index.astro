---
import BaseLayout from '@/layouts/BaseLayout.astro';
import ShortsGrid from '@/components/feature/shorts/shorts-grid.astro';
import { getCollection } from 'astro:content';

import { compileMarkdown } from '@/components/feature/content/custom-markdown';
import { getFirstPage } from '@/lib/shorts';

const allShorts = await getCollection('shorts');
const sortedShorts = allShorts.sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);

const compiledShorts = await Promise.all(
  sortedShorts.map(async (short) => {
    // Split BEFORE compiling
    const firstPageMarkdown = getFirstPage(short.body ?? '');
    const compiledHtml = await compileMarkdown({ source: firstPageMarkdown });
    return {
      ...short,
      body: compiledHtml,
    };
  }),
);

const title = 'Shorts';
const description = '技術的な短いメモやTips、Q&Aなどのまとめ';
---

<BaseLayout title={title} description={description}>
  <div class='container py-10'>
    <div
      class='flex flex-col items-start gap-4 md:flex-row md:justify-between md:gap-8 mb-10'
    >
      <div class='flex-1 space-y-4'>
        <h1 class='inline-block font-bold text-4xl tracking-tight lg:text-5xl'>
          {title}
        </h1>
        <p class='text-xl text-muted-foreground'>
          {description}
        </p>
      </div>
    </div>

    <ShortsGrid shorts={compiledShorts} />
  </div>
</BaseLayout>
