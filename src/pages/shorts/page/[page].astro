---
import BaseLayout from '@/layouts/BaseLayout.astro';
import ShortsGrid from '@/components/feature/shorts/shorts-grid.astro';
import { getCollection } from 'astro:content';
import { Icons } from '@/components/icons';
import { paginateItems } from '@/lib/pagination';
import { SHORTS_CONSTANTS } from '@/constants';
import { absoluteUrl } from '@/lib/utils';
import Pagination from '@/components/shared/pagination-item.astro';

import { compileMarkdown } from '@/components/feature/content/custom-markdown';
import { getFirstPage } from '@/lib/shorts';

export async function getStaticPaths() {
  const allShorts = await getCollection('shorts');
  const totalPages = Math.ceil(
    allShorts.length / SHORTS_CONSTANTS.POSTS_PER_PAGE,
  );

  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: String(i + 1) },
  }));
}

const { page } = Astro.params;
const pageNum = Number.parseInt(page, 10);

if (Number.isNaN(pageNum)) {
  return Astro.redirect('/404');
}

const allShorts = await getCollection('shorts');
const sortedShorts = allShorts.sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);

const totalShorts = sortedShorts.length;
const {
  items: paginatedShorts,
  currentPage,
  totalPages,
} = paginateItems({
  items: sortedShorts,
  page: pageNum,
  pageSize: SHORTS_CONSTANTS.POSTS_PER_PAGE,
});

if (currentPage > totalPages) {
  return Astro.redirect('/404');
}

const compiledShorts = await Promise.all(
  paginatedShorts.map(async (short) => {
    // Split BEFORE compiling
    const firstPageMarkdown = getFirstPage(short.body ?? '');
    const compiledHtml = await compileMarkdown({ source: firstPageMarkdown });
    return {
      ...short,
      body: compiledHtml,
    };
  }),
);

const title = 'Shorts';
const description = '技術的な短いメモやTips、Q&Aなどのまとめ';
const canonicalUrl = absoluteUrl(`/shorts/page/${page}`);
---

<BaseLayout title={title} description={description} canonicalUrl={canonicalUrl}>
  <section class='space-y-10' data-pagefind-ignore>
    <div class='space-y-3 border-b border-border/60 pb-4'>
      <nav class='flex items-center gap-2 text-sm text-muted-foreground'>
        <a href='/' class='transition-colors hover:text-primary'> Home </a>
        <Icons.ChevronRight client:load className='size-4' />
        <span class='text-foreground'>Shorts</span>
      </nav>

      <div class='flex flex-wrap items-end justify-between gap-3'>
        <div class='space-y-2'>
          <h1 class='text-3xl font-bold tracking-tight md:text-4xl'>Shorts</h1>
          <p class='text-base text-muted-foreground'>
            {description}
          </p>
        </div>
        <span class='text-sm font-mono text-muted-foreground'>
          Total {totalShorts} posts
        </span>
      </div>
    </div>

    <ShortsGrid shorts={compiledShorts} />

    <Pagination
      currentPage={currentPage}
      totalPages={totalPages}
      basePath='/shorts/page'
    />
  </section>
</BaseLayout>
