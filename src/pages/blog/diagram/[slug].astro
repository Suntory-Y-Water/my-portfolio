---
import DynamicPageBuilder from '@/components/feature/diagram/dynamic-page-builder';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { absoluteUrl } from '@/lib/utils';
import { siteConfig } from '@/config/site';
import { Icons } from '@/components/icons';
import { buttonVariants } from '@/components/ui/button';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');

  // diagramフィールドを持つ記事のみをフィルタリング
  const diagramPosts = allPosts.filter((post) => post.data.diagram);

  return diagramPosts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;

const sections = post.data.diagram;

// OGP画像のURL
const ogImageUrl = absoluteUrl(`/blog/ogp/${post.id}.png`);

// JSON-LD構造化データ
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  datePublished: post.data.date.toISOString(),
  ...(post.data.modified_time && {
    dateModified: post.data.modified_time.toISOString(),
  }),
  description: post.data.description,
  image: ogImageUrl,
  url: absoluteUrl(`/blog/diagram/${post.id}`),
  author: { '@type': 'Person', name: siteConfig.name, url: siteConfig.url },
  publisher: {
    '@type': 'Organization',
    name: siteConfig.name,
    logo: {
      '@type': 'ImageObject',
      url: absoluteUrl('/opengraph-image.png'),
    },
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': absoluteUrl(`/blog/diagram/${post.id}`),
  },
};

const canonicalUrl = absoluteUrl(`/blog/diagram/${post.id}`);
---

<BaseLayout
  title=`${post.data.title} - 図解`
  description=`ブログ [${post.data.title}] で解説した内容の図解`
  canonicalUrl={canonicalUrl}
  ogType='article'
  article={{
    publishedTime: post.data.date.toISOString(),
    modifiedTime: post.data.modified_time?.toISOString(),
    author: siteConfig.name,
    section: post.data.tags?.[0],
    tags: post.data.tags,
  }}
>
  <script
    type='application/ld+json'
    is:inline
    set:html={JSON.stringify(jsonLd)}
  />
  <div data-pagefind-ignore>
    <div class='mb-6 flex items-center justify-between'>
      <a
        href={`/blog/${post.id}`}
        class={buttonVariants({ variant: 'ghost', size: 'sm' })}
      >
        <span class='group inline-flex items-center'>
          <Icons.arrowLeft
            client:load
            className='mr-2 size-4 transition-transform group-hover:-translate-x-1'
          />
          ブログ記事に戻る
        </span>
      </a>
    </div>
    <DynamicPageBuilder data={sections} />
  </div>
</BaseLayout>
