---
import '@/styles/markdown.css';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getAllBlogPosts, getBlogPostBySlug } from '@/lib/markdown';
import { getRelatedPosts } from '@/lib/recommend';
import { extractTOC } from '@/lib/toc';
import { getInlineIcon } from '@/lib/inline-icons';
import { absoluteUrl, formatDate } from '@/lib/utils';
import { siteConfig } from '@/config/site';
import { getTagSlug } from '@/config/tag-slugs';
import { BLOG_CONSTANTS } from '@/constants';
import { compileMarkdown } from '@/components/feature/content/custom-markdown';
import MarkdownContent from '@/components/feature/content/markdown-content.astro';
import GitHubEditButton from '@/components/feature/content/github-edit-button.astro';
import { MarkdownCopyButton } from '@/components/feature/content/markdown-copy-button';
import RelatedArticles from '@/components/feature/content/related-articles.astro';
import { SelfAssessment } from '@/components/feature/content/self-assessment';
import TableOfContents from '@/components/feature/content/table-of-contents.astro';
import { LikeButton } from '@/components/feature/content/like-button';
import { Icons } from '@/components/icons';
import { Badge } from '@/components/ui/badge';
import { buttonVariants } from '@/components/ui/button';
import { Image } from 'astro:assets';

/**
 * @see https://docs.astro.build/en/guides/typescript/#infer-getstaticpaths-types
 */
export async function getStaticPaths() {
  const allPosts = await getAllBlogPosts();
  return allPosts.map((post) => ({
    params: { slug: post.id },
    props: { allPosts }, // 全記事データをprops経由で渡す
  }));
}

const { slug } = Astro.params;
const { allPosts } = Astro.props; // props経由で受け取る
const post = await getBlogPostBySlug(slug);

if (!post) {
  return Astro.redirect('/404');
}

const relatedPosts = getRelatedPosts({
  currentSlug: slug,
  allPosts,
  count: BLOG_CONSTANTS.RELATED_POSTS_COUNT,
});

const tableOfContents = extractTOC(post.body);
const displayUrl =
  post.data.icon_url ||
  (post.data.icon?.startsWith('https://') ? post.data.icon : null);
const inlineSvg = displayUrl ? getInlineIcon(displayUrl) : undefined;

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  datePublished: post.data.date.toISOString(),
  ...(post.data.modified_time && {
    dateModified: post.data.modified_time.toISOString(),
  }),
  description: post.data.description,
  image: absoluteUrl(`/blog/ogp/${post.id}.png`),
  url: absoluteUrl(`/blog/${post.id}`),
  author: { '@type': 'Person', name: siteConfig.name, url: siteConfig.url },
  publisher: {
    '@type': 'Organization',
    name: siteConfig.name,
    logo: {
      '@type': 'ImageObject',
      url: absoluteUrl('/opengraph-image.png'),
    },
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': absoluteUrl(`/blog/${post.id}`),
  },
};

const canonicalUrl = absoluteUrl(`/blog/${post.id}`);

// GitHubEditButton用のファイルパスを生成
// フロントマターのdateとslugから元のファイル名を復元
const dateStr = post.data.date.toISOString().split('T')[0]; // YYYY-MM-DD
const githubFilePath = `contents/blog/${dateStr}_${post.id}.md`;

// Content Collectionsでコンパイル（Astroが最適化）
const compiledHtml = await compileMarkdown({ source: post.body });
---

<BaseLayout
  title={post.data.title}
  description={post.data.description}
  ogImage={absoluteUrl(`/blog/ogp/${post.id}.png`)}
  canonicalUrl={canonicalUrl}
  ogType='article'
  article={{
    publishedTime: post.data.date.toISOString(),
    modifiedTime: post.data.modified_time?.toISOString(),
    author: siteConfig.name,
    section: post.data.tags?.[0],
    tags: post.data.tags,
  }}
>
  <script
    type='application/ld+json'
    is:inline
    set:html={JSON.stringify(jsonLd)}
  />
  <div>
    <article class='min-h-[500px]'>
      <div class='mb-6 flex items-center justify-between'>
        <a
          href='/blog'
          class={buttonVariants({ variant: 'ghost', size: 'sm' })}
        >
          <span class='group inline-flex items-center'>
            <Icons.arrowLeft
              client:load
              className='mr-2 size-4 transition-transform group-hover:-translate-x-1'
            />
            ブログ一覧に戻る
          </span>
        </a>
      </div>
      {
        (displayUrl || post.data.icon) && (
          <div
            class='mb-6 flex justify-center'
            transition:name={`blog-icon-${slug}`}
          >
            {inlineSvg ? (
              <span
                class='h-20 w-20 [&>svg]:h-full [&>svg]:w-full [&>svg]:object-contain'
                aria-hidden
                set:html={inlineSvg}
              />
            ) : displayUrl ? (
              <Image
                src={displayUrl}
                alt={`Icon for ${post.data.title}`}
                width={80}
                height={80}
                priority
              />
            ) : (
              <div class='text-6xl'>{post.data.icon}</div>
            )}
          </div>
        )
      }
      <div
        class='mb-6 flex flex-wrap items-center justify-between text-sm text-muted-foreground'
      >
        {
          post.data.date && (
            <div
              class='inline-flex items-center gap-1'
              transition:name={`blog-date-${slug}`}
            >
              <Icons.Calendar client:load className='size-4' />
              <time datetime={post.data.date.toISOString()}>
                {formatDate(post.data.date.getTime())}
              </time>
            </div>
          )
        }
        {
          post.data.tags && post.data.tags.length > 0 && (
            <div class='inline-flex flex-wrap gap-2'>
              {post.data.tags.map((tag) => (
                <a href={`/tags/${getTagSlug(tag)}`}>
                  <Badge client:load className='px-2 py-0.5 text-xs'>
                    {tag}
                  </Badge>
                </a>
              ))}
            </div>
          )
        }
      </div>
      <div
        class='flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between'
      >
        <h1
          class='text-2xl font-bold leading-snug tracking-normal'
          transition:name={`blog-title-${slug}`}
        >
          {post.data.title}
        </h1>
        <div class='self-start sm:self-auto'>
          <MarkdownCopyButton client:idle content={post.body} />
        </div>
      </div>
      {
        post.data.description && (
          <p class='mt-4 text-foreground/80'>{post.data.description}</p>
        )
      }
      {
        post.data.diagram && (
          <div class='mt-4'>
            <a
              href={`/blog/diagram/${post.id}`}
              class={buttonVariants({ variant: 'outline', size: 'sm' })}
            >
              <span class='inline-flex items-center gap-1.5'>
                <Icons.Image client:load className='size-4' />
                図解ページはこちら
              </span>
            </a>
          </div>
        )
      }
      {
        tableOfContents.length > 0 && (
          <TableOfContents items={tableOfContents} />
        )
      }
      <div class='mt-8'>
        <MarkdownContent html={compiledHtml} />
      </div>
      {
        post.data.selfAssessment && (
          <SelfAssessment
            client:load
            selfAssessment={post.data.selfAssessment}
          />
        )
      }
      <footer
        class='mt-10 flex flex-wrap items-center justify-between gap-4 border-t pt-8'
      >
        <div class='flex items-center space-x-2'>
          <a
            href={`/blog/${slug}.md`}
            class='inline-flex items-center gap-1.5 px-2 py-1 text-sm text-muted-foreground hover:text-primary'
          >
            <Icons.FileText client:load className='size-4' />
            <span>Markdown ver</span>
          </a>
          <GitHubEditButton filePath={githubFilePath} />
        </div>
      </footer>
    </article>
    <RelatedArticles relatedPosts={relatedPosts} />
  </div>
</BaseLayout>
