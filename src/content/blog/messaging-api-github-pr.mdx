---
title: LINE Messaging APIã‹ã‚‰è‡ªå‹•ã§GitHubã«PRã‚’ç™ºè¡Œã™ã‚‹
public: true
date: 2025-03-20
icon: ğŸ”¥
slug: messaging-api-github-pr
tags: 
  - LINE Messaging API
  - Cloudflare Workers
  - Notion
description: ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã®æŠ€è¡“è¨˜äº‹æŠ•ç¨¿é »åº¦ã‚’ã‚ã’ã‚‹ãŸã‚ã«Notion + Messaging APIã§ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’è‡ªå‹•ã§Pull Requestã‚’ç™ºè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚mdxãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã¯
---


## Cloudflare Workersã«ã‚µãƒ¼ãƒã‚’æ§‹ç¯‰ã™ã‚‹

LINE Messaging APIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ãŸã‚ã®ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦ã€Cloudflare Workersã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
Cloudflare Workersã¯ã€CloudflareãŒæä¾›ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã‚ã‚Šã€ã‚¨ãƒƒã‚¸ï¼ˆCDNã®æ‹ ç‚¹ï¼‰ã§ç›´æ¥ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã§ã€å¾“æ¥ã®ã‚µãƒ¼ãƒãƒ¼ã‚„ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ä»£ã‚ã‚Šã«ã€Cloudflareã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸Šã§ã‚³ãƒ¼ãƒ‰ãŒå‹•ä½œã—ã€é«˜é€Ÿã‹ã¤ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªå‡¦ç†ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### æŠ€è¡“é¸å®šã®ç†ç”±

ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã¯ä¸€èˆ¬çš„ã«ã€ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã¨å‘¼ã°ã‚Œã‚‹å•é¡ŒãŒç™ºç”Ÿã—ã¾ã™ã€‚
ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã¨ã¯ã€ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ç’°å¢ƒã§åˆã‚ã¦é–¢æ•°ã‚’å‘¼ã³å‡ºã—ãŸã¨ãã«ã€ãã®é–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã«å¿…è¦ãªã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã•ã‚Œã‚‹ã¾ã§ã«æ™‚é–“ãŒã‹ã‹ã‚‹ç¾è±¡ã§ã™ã€‚
ã“ã®çµæœã€åˆå›ã®å‘¼ã³å‡ºã—ã¯é…å»¶ãŒç™ºç”Ÿã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

Cloudflare Workersã®æœ€å¤§ã®åˆ©ç‚¹ã¯ã€ã“ã®ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆãŒç™ºç”Ÿã›ãšã€åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã§ã‚‚é«˜é€Ÿã«å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹ç‚¹ã«ã‚ã‚Šã¾ã™ã€‚
ã“ã®ç‰¹æ€§ã¯ã€LINE Messaging APIã®ã‚ˆã†ãªå³æ™‚å¿œç­”ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã«æœ€é©ã§ã™ã€‚
è©³ã—ã„è§£èª¬ã¯ä»¥ä¸‹ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚
<LinkPreview url="https://zenn.dev/msy/articles/4c48d9d9e06147" />

## å®Ÿè£…ã—ãŸã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

ä»Šå›ã®å®Ÿè£…ã§ã¯ã€LINE Messaging APIã®Webhook URLã¨ã—ã¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ã—ã¦ã€ã“ã®Workersã¯ä»–LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„Notionã®ãƒšãƒ¼ã‚¸URLä»¥å¤–ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ãªã„ã‚ˆã†ã€å¿…è¦æœ€ä½é™ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚
<LinkPreview url="https://github.com/Suntory-Y-Water/blog-worker" />


### ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’ctx.waitUntil()ã§ãƒ©ãƒƒãƒ—

LINE Messaging APIã®ä»•æ§˜ä¸Šã€botã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰2ç§’ä»¥å†…ã‚’ç›®å®‰ã«HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰200ã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã®æ™‚é–“åˆ¶ç´„ã‚’å®ˆã‚‰ãªã„å ´åˆã€LINE Messaging APIã‹ã‚‰ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼ãŒè¿”å´ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
<LinkPreview url="https://developers.line.biz/ja/docs/partner-docs/development-guidelines/#webhook-flow-image" />
é€šå¸¸ã®Workersç’°å¢ƒã§ã¯ã€å‡¦ç†ã«2ç§’ä»¥ä¸Šã‹ã‹ã‚‹ã¨LINE Messaging APIã¨ã®é€šä¿¡ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã™ã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚
<LinkPreview url="https://developers.line.biz/ja/docs/partner-docs/development-guidelines/#error-notification" />

ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€é‡ãŸã„éåŒæœŸå‡¦ç†ã‚’`ctx.waitUntil()`ã§ãƒ©ãƒƒãƒ—ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ã¯å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§éåŒæœŸå‡¦ç†ã‚’ç¶™ç¶šã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

<LinkPreview url="https://developers.cloudflare.com/workers/runtime-apis/context/#waituntil" />

ä»¥ä¸‹ã®å®Ÿè£…ã§ã¯Notion APIã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å¤‰æ›ã€MDXãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã¨ã„ã£ãŸæ™‚é–“ã®ã‹ã‹ã‚‹å‡¦ç†ã‚’`ctx.waitUntil()`å†…ã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

```typescript:index.ts
import type { WebhookRequestBody } from '@line/bot-sdk';
import { $getPageFullContent } from '@notion-md-converter/core';
import { NotionZennMarkdownConverter } from '@notion-md-converter/zenn';
import { Client } from '@notionhq/client';
import { sendMessage } from './lib/line-lib';

import type { NotionResponse } from './types';

import { createGithubPr } from './lib/github-lib';
import { createMdxContent } from './lib/mdx-lib';

export default {
  async fetch(request, env, ctx): Promise<Response> {
    try {
      // LINEã®Webhookã‚’å—ã‘å–ã‚‹
      const body = await request.json<WebhookRequestBody>();

      if (body.events && body.events.length > 0) {
        const event = body.events[0];
        if (event.type !== 'message' || event.message.type !== 'text') {
          return new Response('ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ãã ã•ã„', { status: 400 });
        }

        const text = event.message.text;

        const notionPageUrlRegex = /^https:\/\/www\.notion\.so\/.+/;
        if (!notionPageUrlRegex.test(text)) {
          return new Response('notionã®ãƒšãƒ¼ã‚¸URLã‚’æŒ‡å®šã—ã¦ãã ã•ã„', { status: 400 });
        }

        const pageId = text.split('?')[0].split('/').pop()?.slice(-32);

        if (!pageId) {
          return new Response('notionã®ãƒšãƒ¼ã‚¸URLã‚’æŒ‡å®šã—ã¦ãã ã•ã„', { status: 400 });
        }

        ctx.waitUntil(
          (async () => {
            try {
              // notion clientã‚’ä½¿ç”¨ã—ã¦ã€ãƒšãƒ¼ã‚¸ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
              const client = new Client({
                auth: env.NOTION_API_KEY,
              });

              const page = (await client.pages.retrieve({
                page_id: pageId,
              })) as NotionResponse;

              const title = page.properties.title.title[0].plain_text;
              const date = page.properties.date.last_edited_time;
              const description = page.properties.description.rich_text[0].plain_text;
              const icon = page.icon.emoji;
              const tags = page.properties.tags.multi_select.map((tag) => tag.name);
              const slug = page.properties.slug.rich_text[0].plain_text;
              const isPublic = page.properties.public.checkbox;

              // Notionã®ãƒšãƒ¼ã‚¸å†…å®¹ã‚’å–å¾—
              const content = await $getPageFullContent(client, pageId);

              // Zennå½¢å¼ã«å¤‰æ›
              const executor = new NotionZennMarkdownConverter();
              const markdown = executor.execute(content);

              // MDXãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
              const mdxContent = createMdxContent(
                title,
                isPublic,
                date,
                icon,
                slug,
                tags,
                description,
                markdown,
              );

              // GitHubã«PRã‚’ä½œæˆ
              const branchName = await createGithubPr(env.GITHUB_TOKEN, mdxContent, slug);

              // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’LINEã«é€ä¿¡
              const replyText = `GitHubã®PRã‚’ä½œæˆã—ã¾ã—ãŸï¼\nãƒ–ãƒ©ãƒ³ãƒå : ${branchName}\nä»¥ä¸‹ã®URLã‹ã‚‰Pull Requestã‚’ç¢ºèªã—ã¦ä¸‹ã•ã„ã€‚\nhttps://github.com/Suntory-Y-Water/my-portfolio/compare/main...${branchName}`;
              await sendMessage({
                message: replyText,
                replyToken: event.replyToken,
                accessToken: env.LINE_CHANNEL_ACCESS_TOKEN,
              });
            } catch (error) {
              const message = error instanceof Error ? error.message : 'unknown error';
              return new Response(message, { status: 500 });
            }
          })(),
        );

        return new Response('ok!', { status: 200 });
      }

      return new Response('LINEçµŒç”±ã§ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ãã ã•ã„', {
        status: 400,
      });
    } catch (error) {
      const message = error instanceof Error ? error.message : 'unknown error';
      return new Response(message, { status: 500 });
    }
  },
} satisfies ExportedHandler<Env>;
```


### MDXãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå¤‰æ›

Notionã‹ã‚‰å–å¾—ã—ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ã€ãã®ã¾ã¾ã§ã¯ãƒ–ãƒ­ã‚°ã«é©ã—ãŸå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãã“ã§ã€ä»¥ä¸‹ã®å¤‰æ›å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚
1. Zennå½¢å¼ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã¸ã®å¤‰æ›
2. ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸ã®å¤‰æ›
3. ã‚³ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã®é©åˆ‡ãªå½¢å¼ã¸ã®å¤‰æ›
ã“ã‚Œã‚‰ã®å‡¦ç†ã«ã‚ˆã‚Šã€Notionã§ä½œæˆã—ãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è‡ªå‹•çš„ã«ãƒ–ãƒ­ã‚°ç”¨ã®MDXå½¢å¼ã«å¤‰æ›ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

```typescript:mdx-lib.ts
/**
 * MDXãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
 * @param title è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«
 * @param isPublic å…¬é–‹è¨­å®š
 * @param date æ—¥ä»˜
 * @param icon ã‚¢ã‚¤ã‚³ãƒ³
 * @param slug ã‚¹ãƒ©ãƒƒã‚°
 * @param tags ã‚¿ã‚°é…åˆ—
 * @param description èª¬æ˜
 * @param markdown ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
 * @returns ç”Ÿæˆã•ã‚ŒãŸMDXã‚³ãƒ³ãƒ†ãƒ³ãƒ„
 */
export function createMdxContent(
  title: string,
  isPublic: boolean,
  date: string,
  icon: string,
  slug: string,
  tags: string[],
  description: string,
  markdown: string,
): string {
  // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚’MDXå½¢å¼ã«å¤‰æ›
  const mdxContent = convertZennToMdx(markdown);
  // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å†…ã®å˜ç‹¬URLã‚’LinkPreviewã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¤‰æ›
  const transformedMdxContent = transformLinksToPreviewComponent(mdxContent);

  // ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼ã®ä½œæˆ
  // ã‚¿ã‚°ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’çµ±ä¸€ï¼ˆ2ã‚¹ãƒšãƒ¼ã‚¹ï¼‰
  const tagsString = tags.map((tag) => `  - ${tag}`).join('\n');

  // æ—¥ä»˜ã‚’ã€ŒYYYY-MM-DDã€å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
  const dateObj = new Date(date);
  const formattedDate = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;

  // MDXãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆãªã—ã€é©åˆ‡ãªæ”¹è¡Œã‚ã‚Šï¼‰
  return `---
title: ${title}
public: ${isPublic}
date: ${formattedDate}
icon: ${icon}
slug: ${slug}
tags: 
${tagsString}
description: ${description}
---

${transformedMdxContent}`;
}

/**
 * Zennã®:::messageãƒ–ãƒ­ãƒƒã‚¯ã‚’MDXã®<Callout>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¤‰æ›ã™ã‚‹é–¢æ•°
 * @param markdown Zennå½¢å¼ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
 * @returns <Callout>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ã—ãŸMDXå½¢å¼ã®ãƒ†ã‚­ã‚¹ãƒˆ
 */
export function convertZennToMdx(markdown: string): string {
  // Zennã®:::messageãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¤œå‡ºã™ã‚‹æ­£è¦è¡¨ç¾
  // :::message [type] ã§å§‹ã¾ã‚Šã€:::ã§çµ‚ã‚ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¤œå‡º
  const messageBlockRegex = /:::message(?:\s+([a-z]+))?\n([\s\S]*?):::/g;

  // å¤‰æ›å‡¦ç†
  return markdown.replace(
    messageBlockRegex,
    (_, type: string | undefined, content: string | undefined) => {
      // contentãŒundefinedã®å ´åˆã¯ç©ºæ–‡å­—åˆ—ã«ã™ã‚‹
      const safeContent = content || '';

      // contentã®å‰å¾Œã®ç©ºç™½è¡Œã‚’å‰Šé™¤
      const trimmedContent = safeContent.trim();

      // è¤‡æ•°è¡Œã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å„è¡Œã«ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦æ•´å½¢
      const indentedContent = trimmedContent
        .split('\n')
        .map((line: string) => `  ${line}`)
        .join('\n');

      // typeã®å¤‰æ›
      // alert -> warning
      // info -> info (default)
      // typeãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ "info" ã¨ã™ã‚‹
      let calloutType = 'info';
      if (type === 'alert') {
        calloutType = 'warning';
      } else if (type) {
        calloutType = type;
      }

      // <Callout>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç”Ÿæˆ
      return `<Callout type="${calloutType}" title="">\n${indentedContent}\n</Callout>\n`;
    },
  );
}

/**
 * URLã‚’æ¤œå‡ºã™ã‚‹æ­£è¦è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³
 * ç©ºç™½ã€æ”¹è¡Œã€ã¾ãŸã¯ç‰¹å®šã®å¥èª­ç‚¹ã§åŒºåˆ‡ã‚‰ã‚ŒãŸURLã‚’æ¤œå‡ºã™ã‚‹
 */
const URL_REGEX = /(https?:\/\/[^\s]+)/g;

/**
 * ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒªãƒ³ã‚¯å½¢å¼ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹æ­£è¦è¡¨ç¾
 */
const MARKDOWN_LINK_REGEX = /\[.+?\]\(.+?\)/;

/**
 * URLã‹ã‚‰æœ«å°¾ã®å¥èª­ç‚¹ãªã©ã‚’é™¤å»ã™ã‚‹
 * @param url URLæ–‡å­—åˆ—
 * @returns ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã•ã‚ŒãŸURL
 */
function cleanUrl(url: string): string {
  // URLã®æœ«å°¾ã«ã‚ã‚‹å¥èª­ç‚¹ãªã©ã‚’é™¤å»
  return url.replace(/[.,;:!?)"'>}\]]$/, '');
}

/**
 * æ–‡å­—åˆ—ãŒå˜ç‹¬ã®URLã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹
 * ï¼ˆå‰å¾Œã®ç©ºç™½ã‚’é™¤ã„ãŸä¸Šã§ã€æ–‡å­—åˆ—å…¨ä½“ãŒURLã‹ã©ã†ã‹ï¼‰
 * @param text åˆ¤å®šã™ã‚‹æ–‡å­—åˆ—
 * @returns å˜ç‹¬ã®URLãªã‚‰trueã€ãã†ã§ãªã‘ã‚Œã°false
 */
function isStandaloneUrl(text: string): boolean {
  const trimmed = text.trim();
  const match = trimmed.match(URL_REGEX);

  if (!match || match.length !== 1) {
    return false;
  }

  const cleanedUrl = cleanUrl(match[0]);
  return trimmed === match[0] || trimmed === cleanedUrl;
}

/**
 * ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã®å˜ç‹¬URLã‚’<LinkPreview />ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å¤‰æ›ã™ã‚‹
 *
 * @param markdown å¤‰æ›å¯¾è±¡ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
 * @returns å¤‰æ›å¾Œã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
 */
export function transformLinksToPreviewComponent(markdown: string): string {
  if (!markdown) return markdown;

  // è¡Œã”ã¨ã«å‡¦ç†ã™ã‚‹
  const lines = markdown.split('\n');

  // å¤‰æ›å¾Œã®è¡Œã‚’æ ¼ç´ã™ã‚‹é…åˆ—
  const transformedLines = lines.map((line) => {
    // ã™ã§ã«ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒªãƒ³ã‚¯å½¢å¼ [text](url) ã«ãªã£ã¦ã„ã‚‹å ´åˆã¯å¤‰æ›ã—ãªã„
    if (MARKDOWN_LINK_REGEX.test(line)) {
      return line;
    }

    // è¡ŒãŒå˜ç‹¬ã®URLã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
    if (isStandaloneUrl(line)) {
      const trimmed = line.trim();
      const url = cleanUrl(trimmed);
      return `<LinkPreview url="${url}" />`;
    }

    // ãã‚Œä»¥å¤–ã®å ´åˆã¯å…ƒã®è¡Œã‚’ãã®ã¾ã¾è¿”ã™
    return line;
  });

  // å¤‰æ›å¾Œã®è¡Œã‚’çµåˆã—ã¦è¿”ã™
  return transformedLines.join('\n');
}
```

æ—¢å­˜ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã›ãšã«ç‹¬è‡ªã®å¤‰æ›å‡¦ç†ã‚’å®Ÿè£…ã—ãŸç†ç”±ã¯ã€ã™ã§ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ç‰¹å®šã®å½¢å¼ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç”¨æ„ã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚
ä½œæˆã—ãŸãƒ–ãƒ­ã‚°ãƒšãƒ¼ã‚¸ã®ä¾‹ã¯ã“ã¡ã‚‰ã§ã”ç¢ºèªã„ãŸã ã‘ã¾ã™ã€‚
<LinkPreview url="https://sui-portfolio.vercel.app/blog/add-blog-to-portfolio" />

## GitHubã«PRã‚’ç™ºè¡Œã™ã‚‹

æœ€å¾Œã«å¤‰æ›ã—ãŸMDXãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•çš„ã«GitHubãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã€Pull Requestã‚’ä½œæˆã—ã¾ã™ã€‚ã“ã®å‡¦ç†ã«ã¯`Octokit`ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ä»¥ä¸‹ã®æ‰‹é †ã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
1. ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚³ãƒŸãƒƒãƒˆSHAã‚’å–å¾—
2. æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
3. MDXãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ã‚³ãƒŸãƒƒãƒˆ
4. å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦Pull Requestã‚’æº–å‚™


```typescript:github-lib.ts
import { Octokit } from '@octokit/rest';

/**
 * GitHubã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦pushã™ã‚‹é–¢æ•°
 * @param githubToken GitHub APIã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
 * @param mdxContent ã‚³ãƒŸãƒƒãƒˆã™ã‚‹MDXã‚³ãƒ³ãƒ†ãƒ³ãƒ„
 * @param slug è¨˜äº‹ã®ã‚¹ãƒ©ãƒƒã‚°ï¼ˆURLãƒ‘ã‚¹ï¼‰
 * @returns ä½œæˆã—ãŸãƒ–ãƒ©ãƒ³ãƒå
 */
export async function createGithubPr(
  githubToken: string,
  mdxContent: string,
  slug: string,
): Promise<string> {
  try {
	  const octokit = new Octokit({ auth: githubToken });
    const owner = 'Suntory-Y-Water';
    const repo = 'my-portfolio';
    const baseBranch = 'main';
    const newBranchName = `blog-${slug}`;
    const filePath = `src/content/blog/${slug}.mdx`;

    // mainãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆSHAã‚’å–å¾—
    const { data: refData } = await octokit.git.getRef({
      owner,
      repo,
      ref: `heads/${baseBranch}`,
    });
    const mainSha = refData.object.sha;

    // æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
    await octokit.git.createRef({
      owner,
      repo,
      ref: `refs/heads/${newBranchName}`,
      sha: mainSha,
    });
    console.log(`ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã—ã¾ã—ãŸ: ${newBranchName}`);

    // ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼ˆCloudflare Workerså¯¾å¿œç‰ˆï¼‰
    // TextEncoder/btoa ã‚’ä½¿ç”¨ã—ã¦Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
    const encoder = new TextEncoder();
    const bytes = encoder.encode(mdxContent);
    const base64Content = btoa(String.fromCharCode(...new Uint8Array(bytes)));

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒŸãƒƒãƒˆ
    const { data: commitData } = await octokit.repos.createOrUpdateFileContents({
      owner,
      repo,
      path: filePath,
      message: `add: blog post: ${slug}`,
      content: base64Content,
      branch: newBranchName,
    });
    console.log(`ã‚³ãƒŸãƒƒãƒˆãŒä½œæˆã•ã‚Œã¾ã—ãŸ: ${commitData.commit.sha}`);
    return newBranchName;
  } catch (error) {
    const message = error instanceof Error ? error.message : 'unknown error';
    console.error('GitHubã¸ã®pushã«å¤±æ•—ã—ã¾ã—ãŸ');
    console.error(`message: ${message}`);
    throw error;
  }
}
```

å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¨ã€ä½œæˆã•ã‚ŒãŸPull Requestã®URLã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’LINEã«è¿”ä¿¡ã—ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯Notionã‹ã‚‰LINEãƒœãƒƒãƒˆã«URLã‚’é€ä¿¡ã™ã‚‹ã ã‘ã§ã€ãƒ–ãƒ­ã‚°è¨˜äº‹ã®å…¬é–‹æº–å‚™ãŒæ•´ã†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿç¾ã—ã¾ã—ãŸã€‚

## ã¾ã¨ã‚

ä»Šå›ã®å®Ÿè£…ã§ã¯ã€Cloudflare Workersã¨LINE Messaging APIã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€è¨˜äº‹ä½œæˆã‹ã‚‰å…¬é–‹ã¾ã§ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå¤§å¹…ã«åŠ¹ç‡åŒ–ã•ã‚Œã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ä½œæˆã«é›†ä¸­ã§ãã‚‹ç’°å¢ƒãŒæ•´ã„ã¾ã—ãŸã€‚