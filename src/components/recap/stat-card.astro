---
import { cn } from '@/lib/utils';

interface Props {
  label: string;
  value: number;
  suffix?: string;
  class?: string;
  icon?: any; // Slot for icon is usually better, but keeping simple for now
}

const { label, value, suffix = '', class: className = '' } = Astro.props;
---

<div
  class={cn(
    'bg-white border border-gray-300 rounded-xl p-6 flex items-center gap-4 shadow-xl shadow-gray-200/50 overflow-hidden relative group',
    className,
  )}
>
  <!-- Glow effect -->
  <div
    class='absolute -inset-1 bg-linear-to-r from-blue-100 via-purple-100 to-pink-100 blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-500'
  >
  </div>

  <div class='relative z-10 flex items-center gap-4 w-full'>
    <div class='shrink-0 text-gray-500'>
      <slot name='icon' />
    </div>
    <div class='flex flex-col'>
      <span class='text-xs uppercase tracking-widest text-gray-500 font-medium'
        >{label}</span
      >
      <div class='flex items-baseline gap-1'>
        <span
          class='text-4xl font-bold text-gray-900 count-up'
          data-value={value}>0</span
        >
        {suffix && <span class='text-xl text-gray-500'>{suffix}</span>}
      </div>
    </div>
  </div>
</div>

<script>
  function animateValue(
    obj: Element,
    start: number,
    end: number,
    duration: number,
  ) {
    let startTimestamp: number | null = null;
    const step = (timestamp: number) => {
      if (!startTimestamp) startTimestamp = timestamp;
      const progress = Math.min((timestamp - startTimestamp) / duration, 1);
      // Ease out quart
      const easeProgress = 1 - Math.pow(1 - progress, 4);

      obj.innerHTML = Math.floor(
        easeProgress * (end - start) + start,
      ).toLocaleString();
      if (progress < 1) {
        window.requestAnimationFrame(step);
      }
    };
    window.requestAnimationFrame(step);
  }

  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const target = entry.target;
          const endValue = parseInt(
            target.getAttribute('data-value') || '0',
            10,
          );
          animateValue(target, 0, endValue, 2000);
          observer.unobserve(target);
        }
      });
    },
    { threshold: 0.5 },
  );

  document.querySelectorAll('.count-up').forEach((el) => {
    observer.observe(el);
  });
</script>
