name: Create Short from Issue

on:
  issues:
    types: [labeled]

defaults:
  run:
    shell: bash

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-short:
    if: github.event.label.name == 'short'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - uses: ./.github/actions/setup

      - name: Get Puppeteer version
        id: puppeteer-version
        run: echo "version=$(cat package.json | grep '\"api-translator\"' | head -n 1 | grep -oP '\d+\.\d+\.\d+' || echo '0')" >> "$GITHUB_OUTPUT"

      - name: Cache Puppeteer browsers
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        id: puppeteer-cache
        with:
          path: ~/.cache/puppeteer
          key: puppeteer-${{ runner.os }}-${{ steps.puppeteer-version.outputs.version }}
          restore-keys: |
            puppeteer-${{ runner.os }}-

      - name: Install Chromium for Puppeteer
        if: steps.puppeteer-cache.outputs.cache-hit != 'true'
        run: node node_modules/puppeteer/install.js

      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: ${{ github.event.repository.name }}
          permission-contents: write
          permission-pull-requests: write

      - name: Generate Slug and Date
        id: meta
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰"[Short] "ã‚’é™¤å»
          TITLE="${ISSUE_TITLE#\[Short\] }"

          # ã‚¿ã‚¤ãƒˆãƒ«ã‚’è‹±èªç¿»è¨³ã—ã¦ã‚¹ãƒ©ã‚°åŒ–
          SLUG=$(bun run scripts/translate-title-to-slug.ts "$TITLE")
          echo "slug=$SLUG" >> "$GITHUB_OUTPUT"

          # JSTæ—¥ä»˜å–å¾—
          DATE=$(TZ=Asia/Tokyo date +%Y-%m-%d)
          echo "date=$DATE" >> "$GITHUB_OUTPUT"

          echo "Generated Slug: $SLUG"
          echo "Date (JST): $DATE"

      - name: Extract Issue Content
        id: issue
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # ã‚¿ã‚¤ãƒˆãƒ«ã¯Issueã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰"[Short] "ã‚’é™¤å»
          TITLE="${ISSUE_TITLE#\[Short\] }"

          # æœ¬æ–‡ã‚’æŠ½å‡ºï¼ˆ### æœ¬æ–‡ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä»¥é™ã€ç¢ºèªäº‹é …ã®å‰ã¾ã§ï¼‰
          # æœ€åˆã¨æœ€å¾Œã®ç©ºè¡Œã®ã¿å‰Šé™¤ã€ãã‚Œä»¥å¤–ã¯ãã®ã¾ã¾ä¿æŒ
          CONTENT=$(echo "$ISSUE_BODY" | awk '/^### æœ¬æ–‡$/,/^### ç¢ºèªäº‹é …$/ {
            if ($0 !~ /^### æœ¬æ–‡$/ && $0 !~ /^### ç¢ºèªäº‹é …$/) print
          }' | sed '1{/^$/d}' | sed -e :a -e '/^\n*$/{$d;N;ba' -e '}')

          # ãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å¯¾å¿œ
          {
            echo "title<<EOF"
            echo "$TITLE"
            echo "EOF"
            echo "content<<EOF"
            echo "$CONTENT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Short File
        env:
          SLUG: ${{ steps.meta.outputs.slug }}
          DATE: ${{ steps.meta.outputs.date }}
          TITLE: ${{ steps.issue.outputs.title }}
          CONTENT: ${{ steps.issue.outputs.content }}
        run: |
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå­˜åœ¨ç¢ºèª
          mkdir -p contents/shorts

          # Markdownãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          cat > "contents/shorts/${SLUG}.md" << EOF
          ---
          title: "${TITLE}"
          date: ${DATE}
          ---

          ${CONTENT}
          EOF

          echo "Created: contents/shorts/${SLUG}.md"
          cat "contents/shorts/${SLUG}.md"

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        env:
          SLUG: ${{ steps.meta.outputs.slug }}
          TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        with:
          token: ${{ steps.generate-token.outputs.token }}
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          commit-message: |
            Add short: ${{ steps.issue.outputs.title }}

            Issue: #${{ github.event.issue.number }}
            Slug: ${{ steps.meta.outputs.slug }}
          branch: short/${{ steps.meta.outputs.slug }}
          delete-branch: true
          title: "ğŸ“ Short: ${{ steps.issue.outputs.title }}"
          body: |
            ## Summary

            æ–°ã—ã„Shortã‚’è¿½åŠ ã—ã¾ã™ã€‚

            ## Details

            - **Slug**: `${{ steps.meta.outputs.slug }}`
            - **File**: `contents/shorts/${{ steps.meta.outputs.slug }}.md`

            Closes #${{ github.event.issue.number }}

            ---

            ğŸ¤– This PR was automatically created by GitHub Actions.
          labels: short
          assignees: ${{ github.event.issue.user.login }}
