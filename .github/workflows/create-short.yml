name: Create Short from Issue

on:
  issues:
    types: [labeled]

defaults:
  run:
    shell: bash

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  create-short:
    if: github.event.label.name == 'short'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Generate UUID and Date
        id: meta
        run: |
          # UUIDv4ç”Ÿæˆï¼ˆæœ€åˆã®8æ–‡å­—ã®ã¿ä½¿ç”¨ï¼‰
          UUID=$(uuidgen | cut -d'-' -f1 | tr '[:upper:]' '[:lower:]')
          echo "uuid=$UUID" >> "$GITHUB_OUTPUT"

          # JSTæ—¥ä»˜å–å¾—
          DATE=$(TZ=Asia/Tokyo date +%Y-%m-%d)
          echo "date=$DATE" >> "$GITHUB_OUTPUT"

          echo "Generated UUID: $UUID"
          echo "Date (JST): $DATE"

      - name: Extract Issue Content
        id: issue
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Issueæœ¬æ–‡ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’æŠ½å‡º
          # æœ¬æ–‡ã‚’æŠ½å‡ºï¼ˆ### æœ¬æ–‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä»¥é™ã‚’å–å¾—ï¼‰
          CONTENT=$(echo "$ISSUE_BODY" | sed -n '/### æœ¬æ–‡/,$ p' | tail -n +3)

          # ãƒãƒ«ãƒãƒ©ã‚¤ãƒ³å¯¾å¿œ
          {
            echo "title<<EOF"
            echo "$ISSUE_TITLE"
            echo "EOF"
            echo "content<<EOF"
            echo "$CONTENT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Short File
        env:
          UUID: ${{ steps.meta.outputs.uuid }}
          DATE: ${{ steps.meta.outputs.date }}
          TITLE: ${{ steps.issue.outputs.title }}
          CONTENT: ${{ steps.issue.outputs.content }}
        run: |
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå­˜åœ¨ç¢ºèª
          mkdir -p contents/shorts

          # Markdownãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          cat > "contents/shorts/${UUID}.md" << EOF
          ---
          title: "${TITLE}"
          date: ${DATE}
          ---

          ${CONTENT}
          EOF

          echo "Created: contents/shorts/${UUID}.md"
          cat "contents/shorts/${UUID}.md"

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        env:
          UUID: ${{ steps.meta.outputs.uuid }}
          TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        with:
          token: ${{ github.token }}
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          commit-message: |
            Add short: ${{ steps.issue.outputs.title }}

            Issue: #${{ github.event.issue.number }}
            UUID: ${{ steps.meta.outputs.uuid }}
          branch: short/${{ steps.meta.outputs.uuid }}
          delete-branch: true
          title: "ğŸ“ Short: ${{ steps.issue.outputs.title }}"
          body: |
            ## Summary

            æ–°ã—ã„Shortã‚’è¿½åŠ ã—ã¾ã™ã€‚

            ## Details

            - **Issue**: #${{ github.event.issue.number }}
            - **UUID**: `${{ steps.meta.outputs.uuid }}`
            - **File**: `contents/shorts/${{ steps.meta.outputs.uuid }}.md`

            ---

            ğŸ¤– This PR was automatically created by GitHub Actions.
          labels: short
          assignees: ${{ github.event.issue.user.login }}

      - name: Close Issue
        if: steps.cpr.outputs.pull-request-operation == 'created'
        env:
          GH_TOKEN: ${{ github.token }}
          UUID: ${{ steps.meta.outputs.uuid }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
        run: |
          gh issue close "${ISSUE_NUMBER}" --comment "âœ… Shortãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€PRã‚’ä½œæˆã—ã¾ã—ãŸã€‚

          - **PR**: ${PR_URL}
          - **File**: \`contents/shorts/${UUID}.md\`
          - **Branch**: \`short/${UUID}\`

          PRã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚"
