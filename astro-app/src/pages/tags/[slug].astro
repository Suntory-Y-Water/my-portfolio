---
import BaseLayout from '@/layouts/BaseLayout.astro';
import {BlogCard }from '@/components/feature/content/blog-card';
import { Icons } from '@/components/icons';
import { siteConfig } from '@/config/site';
import { getTagNameFromSlug } from '@/config/tag-slugs';
import { getAllTagSlugs, getBlogPostsByTagSlug } from '@/lib/markdown';
import { getInlineIcon } from '@/lib/inline-icons';
import { absoluteUrl } from '@/lib/utils';

export async function getStaticPaths() {
  const allTagSlugs = await getAllTagSlugs();
  return allTagSlugs.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const tagName = getTagNameFromSlug(slug);

if (!tagName) {
  return Astro.redirect('/404');
}

const posts = await getBlogPostsByTagSlug(slug);

const postsWithIcons = posts.map((blog) => {
  const displayUrl = blog.metadata.icon_url || (blog.metadata.icon?.startsWith('https://') ? blog.metadata.icon : null);
  const inlineSvg = displayUrl ? getInlineIcon(displayUrl) : undefined;
  return { blog, inlineSvg };
});

const title = `「${tagName}」タグの記事一覧`;
const description = `「${tagName}」タグの記事一覧を表示しています。`;
const canonicalUrl = absoluteUrl(`/tags/${slug}`);
---

<BaseLayout title={title} description={description} ogImage={siteConfig.ogImage} canonicalUrl={canonicalUrl}>
  <section data-pagefind-ignore class="space-y-10">
    <div class="space-y-3 border-b border-border/60 pb-4">
      <nav class="flex items-center gap-2 text-sm text-muted-foreground">
        <a href="/" class="transition-colors hover:text-primary">Home</a>
        <Icons.ChevronRight client:load class="size-4" />
        <a href="/tags" class="transition-colors hover:text-primary">Tags</a>
        <Icons.ChevronRight client:load class="size-4" />
        <span class="text-foreground">{tagName}</span>
      </nav>

      <div class="flex flex-wrap items-end justify-between gap-3">
        <h1 class="text-3xl font-bold tracking-tight md:text-4xl">{tagName}</h1>
        <span class="text-sm font-mono text-muted-foreground">Total {posts.length} posts</span>
      </div>
    </div>

    <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
      {postsWithIcons.map(({ blog, inlineSvg }) => (
        <BlogCard key={blog.slug} data={blog} inlineSvg={inlineSvg} />
      ))}
    </div>
  </section>
</BaseLayout>
