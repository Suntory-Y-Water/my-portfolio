---
title: HonoXã«Vitestã‚’å°å…¥ã™ã‚‹
slug: installing-vitest-honox
date: 2025-06-01
modified_time: 2025-06-01
description: HonoXã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«Vitestã‚’å°å…¥ã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚Cloudflare Workersã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°D1ã‚’åˆ©ç”¨ã™ã‚‹HonoXã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹ç¯‰ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚
icon: ğŸ˜€
icon_url: /icons/grinning_face_flat.svg
tags:
  - CloudflareWorkers
  - Vitest
  - HonoX
---

## ã¯ã˜ã‚ã«

HonoX ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ç‰¹ã« Cloudflare Workers ä¸Šã§å‹•ä½œã™ã‚‹ã‚‚ã®ã¯ã€D1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€R2 ãƒã‚±ãƒƒãƒˆã€KV ã‚¹ãƒˆã‚¢ã€ç’°å¢ƒå¤‰æ•°ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¨ã„ã£ãŸ Cloudflare ã®å„ç¨®ã‚µãƒ¼ãƒ“ã‚¹ã¨å¯†æ¥ã«é€£æºã—ã¾ã™ã€‚
ã“ã‚Œã‚‰ã®é€£æºéƒ¨åˆ†ã‚’å«ã‚ãŸãƒ†ã‚¹ãƒˆã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®å‹•ä½œã‚’ä¿è¨¼ã™ã‚‹ä¸Šã§ä¸å¯æ¬ ã§ã™ã€‚
æœ¬è¨˜äº‹ã¯ Cloudflare Workers ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°(D1)ã‚’åˆ©ç”¨ã™ã‚‹ HonoX ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆã‚’åŠ¹ç‡çš„ã«è¡Œã†ãŸã‚ã®ã‚¬ã‚¤ãƒ‰ã¨ãªã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

## å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™

ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹å‰ã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿…è¦ãªè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’æº–å‚™ã—ã¾ã™ã€‚
ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ä»¥ä¸‹ã® HonoX ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚‹ `blog` é…ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«çµã£ã¦å®Ÿè·µã—ã¦ã„ãã¾ã™ã€‚

https://github.com/yusukebe/honox-examples

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€  (ãƒ†ã‚¹ãƒˆé–¢é€£éƒ¨åˆ†)

```bash
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ routes/ (HonoXã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«)
â”‚   â””â”€â”€ ... (ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰)
â”œâ”€â”€ test/ (ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª)
â”‚   â”œâ”€â”€ env.d.ts (ãƒ†ã‚¹ãƒˆç’°å¢ƒç”¨ã®å‹å®šç¾©)
â”‚   â”œâ”€â”€ vitest.setup.ts (Vitestã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«)
â”‚   â”œâ”€â”€ vitest.config.ts (ãƒ†ã‚¹ãƒˆç”¨ã®Vitestè¨­å®š)
â”‚   â””â”€â”€ routes/ (ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ«ãƒ¼ãƒˆã«å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«)
â”‚       â””â”€â”€ index.test.tsx (ä¾‹: app/routes/index.tsx ã®ãƒ†ã‚¹ãƒˆ)
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ wrangler.jsonc (Cloudflare Workersã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«)
```

### `package.json` ã¸ã®ä¾å­˜é–¢ä¿‚ã®è¿½åŠ 

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® `package.json` ã«ã€ãƒ†ã‚¹ãƒˆã«å¿…è¦ãªé–‹ç™ºä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ ã—ã¾ã™ã€‚
`vitest` ã¨ `@cloudflare/vitest-pool-workers` ã«é™ã‚Šã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® `pnpm add -D vitest@~3.1.0 @cloudflare/vitest-pool-workers` ã«å¾“ã£ã¦ã„ã¾ã™ã€‚

```bash
pnpm add -D vitest@~3.1.0 @cloudflare/vitest-pool-workers vite-tsconfig-paths @types/node
```

å¾Œç¶šå‡¦ç†ã§ `wrangler` ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ 4 ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€å„ç¨®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æœ€æ–°åŒ–ã—ã¦ã„ãã¾ã™ã€‚
```bash
pnpm update --latest
```
### `wrangler.jsonc` ã®è¨­å®šç¢ºèª

ãƒ†ã‚¹ãƒˆå¯¾è±¡ã® Cloudflare Workers ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚° (D1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€R2 ãƒã‚±ãƒƒãƒˆã€ç’°å¢ƒå¤‰æ•°ãªã©) ãŒ `wrangler.jsonc` ã«æ­£ã—ãå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚
`@cloudflare/vitest-pool-workers` ã¯ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ãƒ†ã‚¹ãƒˆç’°å¢ƒã«ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’æä¾›ã—ã¾ã™ã€‚

```json
{
  "$schema": "./node_modules/wrangler/config-schema.json",
  "name": "honox-examples-blog",
  "main": "./dist/index.js",
  "compatibility_date": "2024-04-01",
  "compatibility_flags": ["nodejs_compat"],
  "assets": {
    "directory": "./dist"
  },
  "d1_databases": [
    {
      "binding": "DB",
      "database_name": "hono-blog-demo-local",
      "database_id": "7d4931d8-eb0d-41cb-ba71-a4d01506828a"
    }
  ]
}
```

### TypeScriptã®è¨­å®š (`tsconfig.json`)

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã® `tsconfig.json` ã«ã€`@cloudflare/workers-types` ã‚„ãƒ†ã‚¹ãƒˆã§ä½¿ã†ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ (`@/*`) ã®è¨­å®šãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```json
{
  "compilerOptions": {
    "target": "ESNext",
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "strict": true,
    "skipLibCheck": true,
    "lib": ["ESNext", "DOM"],
    "types": ["vite/client", "@cloudflare/workers-types/2023-07-01"],
    "jsx": "react-jsx",
    "jsxImportSource": "hono/jsx",
    "baseUrl": ".",
    "paths": {
      "@/*": ["app/*"]
    }
  },
  "include": ["**/*.ts", "**/*.tsx"]
}

```

### `worker-configuration.d.ts` ã®ç”Ÿæˆ


ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã« Cloudflare Workers ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã«å¯¾å¿œã—ãŸå‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ« `worker-configuration.d.ts` ã‚’ `pnpm wrangler types` ã‚³ãƒãƒ³ãƒ‰ã§ç”Ÿæˆã—ã¾ã™ã€‚
```bash
pnpm wrangler types
```
ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§ `c.env.DB` ãªã©ã®å‹æ¨è«–ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚
ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã“ã®ã‚ˆã†ã«å‹æ¨è«–ã‚’ã™ã‚‹ãŸã‚ã«å¿…è¦ãªå†…å®¹ãŒå¤šæ•°ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
```ts
/* eslint-disable */
// Generated by Wrangler by running `wrangler types` (hash: 751a7ef0204e37564547937fa13c0dba)
// Runtime types generated with workerd@1.20250508.0 2024-04-01 nodejs_compat
declare namespace Cloudflare {
  interface Env {
    DB: D1Database;
  }
}
interface Env extends Cloudflare.Env {}

// Begin runtime types
/*! *****************************************************************************
Copyright (c) Cloudflare. All rights reserved.
Copyright (c) Microsoft Corporation. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0
THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.
See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
/* eslint-disable */
// noinspection JSUnusedGlobalSymbols
declare var onmessage: never;
/**
 * An abnormal event (called an exception) which occurs as a result of calling a method or accessing a property of a web API.
 *
 * [MDN Reference](https://developer.mozilla.org/docs/Web/API/DOMException)
 */
declare class DOMException extends Error {
  constructor(message?: string, name?: string);
  /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/DOMException/message) */
  readonly message: string;
  /* [MDN Reference](https://developer.mozilla.org/docs/Web/API/DOMException/name) */
  readonly name: string;
  /**
   * @deprecated
   *
   * [MDN Reference](https://developer.mozilla.org/docs/Web/API/DOMException/code)
   */
  readonly code: number;
  static readonly INDEX_SIZE_ERR: number;
  static readonly DOMSTRING_SIZE_ERR: number;
  static readonly HIERARCHY_REQUEST_ERR: number;
  static readonly WRONG_DOCUMENT_ERR: number;
  static readonly INVALID_CHARACTER_ERR: number;
  static readonly NO_DATA_ALLOWED_ERR: number;
  static readonly NO_MODIFICATION_ALLOWED_ERR: number;
  static readonly NOT_FOUND_ERR: number;
  static readonly NOT_SUPPORTED_ERR: number;
  static readonly INUSE_ATTRIBUTE_ERR: number;
  static readonly INVALID_STATE_ERR: number;
  static readonly SYNTAX_ERR: number;
  static readonly INVALID_MODIFICATION_ERR: number;
  static readonly NAMESPACE_ERR: number;
  static readonly INVALID_ACCESS_ERR: number;
  static readonly VALIDATION_ERR: number;
  static readonly TYPE_MISMATCH_ERR: number;
  static readonly SECURITY_ERR: number;
  static readonly NETWORK_ERR: number;
  static readonly ABORT_ERR: number;
  static readonly URL_MISMATCH_ERR: number;
  static readonly QUOTA_EXCEEDED_ERR: number;
  static readonly TIMEOUT_ERR: number;
  static readonly INVALID_NODE_TYPE_ERR: number;
  static readonly DATA_CLONE_ERR: number;
  get stack(): any;
  set stack(value: any);
}
// é•·ã™ãã‚‹ã®ã§çœç•¥
```

ã‚‚ã— `interface Env` ã—ã‹ç”Ÿæˆã•ã‚Œãªã„å ´åˆã¯ `wrangler` ã‚’ `pnpm update --latest` ãªã©ã§æœ€æ–°åŒ–ã—ã¦ã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
å®Ÿè¡Œæ™‚ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒãƒ³ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹ã¯ãšã§ã™ï¼
```bash
root âœ /workspaces/honox-examples-sui (feature-vitest-start) $ pnpm wrangler types

 â›…ï¸ wrangler 4.16.1
-------------------

Generating project types...

declare namespace Cloudflare {
        interface Env {
                DB: D1Database;
        }
}
interface Env extends Cloudflare.Env {}

Generating runtime types...

Runtime types generated.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ¨ Types written to worker-configuration.d.ts

Action required Migrate from @cloudflare/workers-types to generated runtime types
`wrangler types` now generates runtime types and supersedes @cloudflare/workers-types.
You should now uninstall @cloudflare/workers-types and remove it from your tsconfig.json.

ğŸ“– Read about runtime types

https://developers.cloudflare.com/workers/languages/typescript/#generate-types

ğŸ“£ Remember to rerun 'wrangler types' after you change your wrangler.json file.
```
## ãƒ†ã‚¹ãƒˆç’°å¢ƒã®è¨­å®š

æ¬¡ã«ã€`test` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ãƒ†ã‚¹ãƒˆå°‚ç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆç”¨ `tsconfig.json` ã®ä½œæˆ

`test/tsconfig.json` ã‚’ä½œæˆã—ã€ãƒ†ã‚¹ãƒˆç’°å¢ƒå›ºæœ‰ã® TypeScript è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

```json
{
  "extends": "../tsconfig.json",
  "compilerOptions": {
    "moduleResolution": "bundler",
    "types": ["vitest/globals", "@cloudflare/vitest-pool-workers"]
  },
  "include": ["./**/*.ts", "./**/*.tsx", "../worker-configuration.d.ts"]
}
```

### ãƒ†ã‚¹ãƒˆç”¨ Vitestè¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (`vitest.config.ts`) ã®ä½œæˆ

`test/vitest.config.ts` ã‚’ä½œæˆã—ã€`@cloudflare/vitest-pool-workers` ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
```typescript
import {
  defineWorkersConfig,
  readD1Migrations,
} from '@cloudflare/vitest-pool-workers/config';
import tsconfigPaths from 'vite-tsconfig-paths';
import path from 'node:path';

export default defineWorkersConfig(async () => {
  const migrationsPath = path.resolve(__dirname, '../migrations');
  const migrations = await readD1Migrations(migrationsPath);

  return {
    plugins: [tsconfigPaths()],
    root: __dirname,
    test: {
      globals: true,
      include: ['./**/*.test.{ts,tsx}'],
      setupFiles: ['./vitest.setup.ts'],
      poolOptions: {
        workers: {
          wrangler: {
            configPath: path.resolve(__dirname, '../wrangler.jsonc'),
          },
          miniflare: {
            bindings: {
              MIGRATIONS: migrations,
            },
          },
        },
      },
    },
  };
});

```
`miniflare.bindings.MIGRATIONS` ã« `readD1Migrations` ã§èª­ã¿è¾¼ã‚“ã  D1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã§ãã¾ã™ã€‚

### ãƒ†ã‚¹ãƒˆç’°å¢ƒç”¨å‹å®šç¾© (`env.d.ts`) ã®ä½œæˆ

`test/env.d.ts` ã‚’ä½œæˆã—ã€ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ `import { SELF, env } from 'cloudflare:test'` ã‚’åˆ©ç”¨ã™ã‚‹éš›ã®å‹å®šç¾©ã‚’è¡Œã„ã¾ã™ã€‚

```typescript
import type { Env as WorkerEnv } from '../worker-configuration';

declare module 'cloudflare:test' {
  interface ProvidedEnv extends WorkerEnv {
    DB: D1Database;
    MIGRATIONS?: D1Migration[];
  }
}

```
`migrationsPath` ã¯ `CREATEæ–‡` ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ SQL ãŒã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€`blog.sql` ã‚’ `migrations/` ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¾ã™ã€‚
`WorkerEnv` ã¯ `wrangler types` ã§ç”Ÿæˆã•ã‚ŒãŸ `worker-configuration.d.ts` ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã‚Šã€`wrangler.jsonc` ã§å®šç¾©ã•ã‚ŒãŸãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®å‹ãŒãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã‚‚åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

### Vitestã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ« (`vitest.setup.ts`) ã®ä½œæˆ

`test/vitest.setup.ts` ã‚’ä½œæˆã—ã€å„ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œå‰ã« D1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã™ã‚‹å‡¦ç†ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```typescript
import { env, applyD1Migrations } from 'cloudflare:test';
import { beforeAll } from 'vitest';

beforeAll(async () => {
  if (env.DB && env.MIGRATIONS) {
    await applyD1Migrations(env.DB, env.MIGRATIONS);
  }
});
```


## æœ€åˆã®ãƒ†ã‚¹ãƒˆã®ä½œæˆ

è¨­å®šãŒå®Œäº†ã—ãŸã‚‰ã€ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
ä¾‹ã¨ã—ã¦ã€`app/routes/index.tsx` ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’ `test/routes/index.test.tsx` ã«ä½œæˆã—ã¾ã™ã€‚
HonoX ã¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ãŸã‚ã€å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã”ã¨ã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã§ãã¾ã™ã€‚

```typescript
import { SELF, env } from 'cloudflare:test';

async function insertTestArticle(article: {
  id: string;
  title: string;
  content: string;
  created_at?: string;
}) {
  const createdAt = article.created_at || new Date().toISOString();
  await env.DB.prepare(
    'INSERT INTO articles (id, title, content, created_at) VALUES (?, ?, ?, ?)',
  )
    .bind(article.id, article.title, article.content, createdAt)
    .run();
}

describe('GET / (app/routes/index.tsx)', () => {
  afterEach(async () => {
    vi.restoreAllMocks();
    await env.DB.exec('DELETE FROM articles;');
  });

  it('è¨˜äº‹ä¸€è¦§ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨', async () => {
    await insertTestArticle({
      id: '1',
      title: 'ãƒ†ã‚¹ãƒˆè¨˜äº‹1',
      content: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆè¨˜äº‹ã®å†…å®¹ã§ã™ã€‚',
      created_at: '2024-01-01T10:00:00.000Z',
    });
    await insertTestArticle({
      id: '2',
      title: 'ãƒ†ã‚¹ãƒˆè¨˜äº‹2',
      content: 'ã“ã‚Œã¯2ã¤ç›®ã®ãƒ†ã‚¹ãƒˆè¨˜äº‹ã§ã™ã€‚',
      created_at: '2024-01-02T10:00:00.000Z',
    });

    const response = await SELF.fetch('http://localhost/');
    expect(response.status).toBe(200);

    const text = await response.text();
    expect(text).toContain('Hono Blog');
    expect(text).toContain('Posts');
    expect(text).toContain('ãƒ†ã‚¹ãƒˆè¨˜äº‹1');
    expect(text).toContain('ãƒ†ã‚¹ãƒˆè¨˜äº‹2');
    expect(text).toContain('Create Post');
  });

  it('è¨˜äº‹ãŒå­˜åœ¨ã—ãªã„å ´åˆã§ã‚‚æ­£å¸¸ã«ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨', async () => {
    const response = await SELF.fetch('http://localhost/');
    expect(response.status).toBe(200);

    const text = await response.text();
    expect(text).toContain('Hono Blog');
    expect(text).toContain('Posts');
    expect(text).toContain('Create Post');
  });

  it('è¨˜äº‹ã®ãƒªãƒ³ã‚¯ãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹ã“ã¨', async () => {
    await insertTestArticle({
      id: 'test-article-id',
      title: 'ãƒ†ã‚¹ãƒˆãƒªãƒ³ã‚¯è¨˜äº‹',
      content: 'ãƒªãƒ³ã‚¯ãƒ†ã‚¹ãƒˆç”¨ã®è¨˜äº‹ã§ã™ã€‚',
    });

    const response = await SELF.fetch('http://localhost/');
    const text = await response.text();

    expect(text).toContain('articles/test-article-id');
    expect(text).toContain('ãƒ†ã‚¹ãƒˆãƒªãƒ³ã‚¯è¨˜äº‹');
  });

  it('è¨˜äº‹ãŒä½œæˆæ—¥æ™‚ã®é™é †ã§è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨', async () => {
    await insertTestArticle({
      id: '1',
      title: 'å¤ã„è¨˜äº‹',
      content: 'å¤ã„è¨˜äº‹ã®å†…å®¹',
      created_at: '2024-01-01T10:00:00.000Z',
    });
    await insertTestArticle({
      id: '2',
      title: 'æ–°ã—ã„è¨˜äº‹',
      content: 'æ–°ã—ã„è¨˜äº‹ã®å†…å®¹',
      created_at: '2024-01-03T10:00:00.000Z',
    });
    await insertTestArticle({
      id: '3',
      title: 'ä¸­é–“ã®è¨˜äº‹',
      content: 'ä¸­é–“ã®è¨˜äº‹ã®å†…å®¹',
      created_at: '2024-01-02T10:00:00.000Z',
    });

    const response = await SELF.fetch('http://localhost/');
    const text = await response.text();

    const newArticleIndex = text.indexOf('æ–°ã—ã„è¨˜äº‹');
    const middleArticleIndex = text.indexOf('ä¸­é–“ã®è¨˜äº‹');
    const oldArticleIndex = text.indexOf('å¤ã„è¨˜äº‹');

    expect(newArticleIndex).toBeLessThan(middleArticleIndex);
    expect(middleArticleIndex).toBeLessThan(oldArticleIndex);
  });

  it('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«é©åˆ‡ã«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã“ã¨', async () => {
    const mockError = new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼');
    const prepareSpy = vi.spyOn(env.DB, 'prepare');

    const mockStatement = {
      all: vi.fn().mockRejectedValue(mockError),
    };
    prepareSpy.mockImplementation(() => mockStatement as any);

    const response = await SELF.fetch('http://localhost/');

    expect(response.status).toBeGreaterThanOrEqual(500);
  });
});

```

## ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

`package.json` ã«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®šç¾©ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
```json
{
  "scripts": {
    "test": "vitest run --config ./test/vitest.config.ts"
    // ä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
  }
}
```

è¨˜è¼‰å¾Œã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
```bash
pnpm test
```

è¨­å®šã«å•é¡ŒãŒãªã‘ã‚Œã°ç„¡äº‹ãƒ†ã‚¹ãƒˆå®Œäº†ã§ã™ï¼
```bash
root âœ /workspaces/honox-examples-sui (feature-vitest-start) $ pnpm run test

> hono-x-examples@ test /workspaces/honox-examples-sui
> vitest run --config ./test/vitest.config.ts


 RUN  v3.1.4 /workspaces/honox-examples-sui/test

[vpw:inf] Starting isolated runtimes for test/vitest.config.ts...
stdout | routes/index.test.tsx
GET   /
POST  /articles/create
GET   /articles/create
POST  /articles/preview
GET   /articles/:id
GET   /*

stdout | routes/index.test.tsx > GET / (app/routes/index.tsx) > ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«é©åˆ‡ã«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã“ã¨
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼

 âœ“ routes/index.test.tsx (5 tests) 261ms
   âœ“ GET / (app/routes/index.tsx) > è¨˜äº‹ä¸€è¦§ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ 53ms
   âœ“ GET / (app/routes/index.tsx) > è¨˜äº‹ãŒå­˜åœ¨ã—ãªã„å ´åˆã§ã‚‚æ­£å¸¸ã«ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ 36ms
   âœ“ GET / (app/routes/index.tsx) > è¨˜äº‹ã®ãƒªãƒ³ã‚¯ãŒæ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ 42ms
   âœ“ GET / (app/routes/index.tsx) > è¨˜äº‹ãŒä½œæˆæ—¥æ™‚ã®é™é †ã§è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ 54ms
   âœ“ GET / (app/routes/index.tsx) > ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«é©åˆ‡ã«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã“ã¨ 26ms

 Test Files  1 passed (1)
      Tests  5 passed (5)
   Start at  14:40:39
   Duration  1.12s (transform 162ms, setup 268ms, collect 12ms, tests 261ms, environment 1ms, prepare 138ms)

[vpw:dbg] Shutting down runtimes...
root âœ /workspaces/honox-examples-sui (feature-vitest-start) $ 
```

## ã¾ã¨ã‚

æœ¬è¨˜äº‹ã§ã¯ã€HonoX ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã« Vitest ã‚’å°å…¥ã—ã€Cloudflare Workers ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’å«ã‚€çµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã—ãŸã€‚

HonoX ã¯ç¾åœ¨Î±ç‰ˆã§ã™ãŒã€Cloudflare è£½å“ã¨ã—ã¦ã®å®‰å®šæ€§ã¨ Hono ã®è¨­è¨ˆæ€æƒ³ã‚’å—ã‘ç¶™ã„ã§ã„ã‚‹ãŸã‚ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®è¨˜è¿°ãŒéå¸¸ã«ç›´æ„Ÿçš„ã§ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«ã‚ˆã‚Šå„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã§ãã€ãƒ†ã‚¹ãƒˆã®æ§‹é€ ãŒæ˜ç¢ºã«ãªã‚Šã¾ã™ã€‚
MPA ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ä¸­å¿ƒã®è¨­è¨ˆã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€è¤‡é›‘ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ã‚’é¿ã‘ã‚‹ã“ã¨ã§ãƒ†ã‚¹ãƒˆã‚‚ç°¡æ½”ã«è¨˜è¿°ã§ãã¾ã™ã€‚
ä»Šå¾Œã‚‚ HonoX ã®æˆç†Ÿã¨ã¨ã‚‚ã«ã€Cloudflare Workers ä¸Šã§ã® Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºãŒã•ã‚‰ã«ç™ºå±•ã™ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ãŸã„ã§ã™ã­ï¼

ä»Šå›ä½¿ç”¨ã—ãŸãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰ã§ã™ã€‚

https://github.com/Suntory-N-Water/honox-examples-sui/tree/feature-vitest-start

## å‚è€ƒ

https://github.com/cloudflare/workers-sdk/tree/main/fixtures/vitest-pool-workers-examples

https://developers.cloudflare.com/workers/testing/vitest-integration/write-your-first-test/