#!/usr/bin/env sh

# ブログアイコンの自動変換とタグチェック
# ステージングされたブログファイルのみを処理
STAGED_BLOG_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep 'contents/blog/.*\.md$' || true)

if [ -n "$STAGED_BLOG_FILES" ]; then
  echo "🔄 ブログアイコンを変換中..."
  # Bunが長大な引数列で不安定になるのを避けるため、10件ずつ処理
  echo "$STAGED_BLOG_FILES" | xargs -n 10 bun run scripts/update-blog-icon.ts

  # 変更されたファイルを再度ステージング
  echo "$STAGED_BLOG_FILES" | xargs git add

  echo "🔍 タグ整合性をチェック中..."
  bun run check:tags || {
    echo "❌ タグチェックに失敗しました。未登録のタグを修正してからコミットしてください。"
    exit 1
  }

  echo "📒 ブログ記事の文章構成をチェック中..."

  # textlintチェックを実行（contents/ディレクトリで実行）
  # .textlintignoreを考慮するため、ファイルを直接渡さずにディレクトリ全体をチェック
  cd contents && bun run lint:textlint || {
    echo "⚠️  Lintエラーを検出。自動修正を試みます..."

    # Lintエラーを自動修正
    bun run lint:textlint:fix || {
      cd ..
      echo "❌ Lintエラーを自動修正できませんでした。手動で修正してからコミットしてください。"
      exit 1
    }

    # 修正後、再度lintチェックを実行
    echo "🔍 自動修正後の再チェック中..."
    bun run lint:textlint || {
      cd ..
      echo "❌ 自動修正後もLintエラーが残っています。手動で修正してからコミットしてください。"
      exit 1
    }

    cd ..
    # 修正されたファイルを再度ステージング
    echo "$STAGED_BLOG_FILES" | xargs git add
    echo "✅ Lintエラーを自動修正し、再チェックに合格しました。"
  }

  cd ..

fi
